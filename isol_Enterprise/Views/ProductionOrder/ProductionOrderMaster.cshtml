@{
    ViewBag.title1 = "Production Order / ";
    ViewBag.title2 = "Add";
    ViewData["Title"] = "ProductionOrder";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model iSOL_Enterprise.Models.RoleModels

@using Microsoft.AspNetCore.Http

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

<!-- Render Body <Start> -->
<script src="~/Assets/plugins/global/plugins.bundle.js"></script>
<script src="~/Assets/js/scripts.bundle.js"></script>
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">

    <!--end::Subheader-->
    <!--begin::Entry-->
    <div class="container">
        <!--begin::Card-->
        <div class="card card-custom card-sticky" id="kt_page_sticky_card">
            <div class="card-header">
                <div class="card-title">
                    <h3 class="card-label">
                        Add Details
                        <i class="mr-2"></i>
                        <!-- <small class="">try to scroll the page</small> -->
                    </h3>
                </div>
                <div class="card-toolbar">
                    <a onclick="Back_his()" class="btn btn-light-primary font-weight-bolder mr-2">
                        <i class="ki ki-long-arrow-back icon-sm"></i>Back
                    </a>
                    <div class="btn-group">

                       
                        <button type="button" class="btn btn-primary font-weight-bolder" id="btnSaveData">
                            <i class="ki ki-check icon-sm"></i>Save
                        </button>

                    </div>
                </div>
            </div>
            <div class="card-body">
                <!--begin::Form-->
                <form class="form" id="kt_form">


                    <input type="hidden" value="@Context.Session.GetString("Name")" id="sessionName" />
                    <input type="hidden" value="@Context.Session.GetString("Email")" id="sessionEmail" />
                    <input type="hidden" value="@Context.Session.GetString("RoleCode")" id="UserRoleCode" />
                    <input type="hidden" value="@Context.Session.GetString("DepartmentCode")" id="_DepartmentCode" />

                    <input type="hidden" value="@Context.Request.Query["Id"]" id="Guid" />
                    <input type="hidden" value="@Context.Request.Query["Source"]" id="PageGuid" />
                    <input type="hidden" value="@Context.Request.Query["DocType"]" id="DocType" />
                    <input type="hidden" value="@Context.Request.Query["DOM"]" id="DOMStatus" />

                    <input type="hidden" value="@Context.Session.GetInt32("UserId")" id="_UserId" />
                    <style>
                        .mr2 {
                            margin: 0% 2% 0% 2%;
                            /*width: 5%;*/
                        }

                        .cr2 {
                            margin: 0% 1% 0% 0%;
                            width: 5%;
                        }

                        .wdth {
                            width: 250% !important;
                        }

                        /*tr > th {
                                                    text-align: left;
                                                    width: 50px !important;
                                                }
                                                table {
                                                   display: table-cell;
                                                    text-align:center;
                                                    overflow-x: auto;
                                                    white-space: nowrap;
                                                }

                                                tr > td {
                                                    text-align: center;
                                                    width: 5% !important;
                                                }*/
                        #kt_repeater_1 {
                            border-collapse: collapse;
                            width: 100%;
                            overflow-x: scroll;
                            display: block;
                        }

                        .ScrollThead,
                        .ScrollTbody {
                            display: inline-block;
                        }

                        .ScrollTbody {
                            overflow-y: auto;
                            overflow-x: hidden;
                            max-height: 300px;
                        }

                            .ScrollTbody td, .ScrollThead
                            th {
                                min-width: 160px;
                                max-width: 160px;
                                height: 40px;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            }

                        .ScrollTbody2 td, .ScrollThead2
                        th {
                            min-width: 100px;
                            max-width: 160px;
                            height: 40px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        }
                    </style>
                    <div class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid">
                        <div class="row">
                            <div class="col-lg-12">
                                <!--begin::Portlet-->
                                <div class="kt-portlet kt-portlet--last kt-portlet--head-lg kt-portlet--responsive-mobile" id="kt_page_portlet">

                                    <div class="kt-portlet__body">
                                        <form autocomplete="off" role="form" class="kt-form" id="F_@Context.Request.Query" name="F_@Context.Request.Query["Source"]">
                                            <div class="row">
                                                <div class="col-xl-12">
                                                    <div class="kt-section kt-section--first">
                                                        <div class="kt-section__body">


                                                            @* ----------   Header -----------*@
                                                            <div id="HeaderForm">
                                                                <div class="form-group row">

                                                                    <div class="col-md-6">
                                                                        <label>Type</label>
                                                                        <select class="form-control" id="Type" name="Type">
                                                                            <option value="S">Standard</option>
                                                                            <option value="P">Special</option>
                                                                            <option value="D">DisAssembly</option>
                                                                        </select>

                                                                    </div>

                                                                    <div class="col-md-6 ">
                                                                        <label>No</label>
                                                                        <div class="row d-flex">


                                                                        <select id="MySeries" name="MySeries"
                                                                                class="form-control form-control-sm col">
                                                                                        @foreach (iSOL_Enterprise.Models.Series.tbl_NNM1 i in ViewBag.MySeries)
                                                                                        {                                                                                            
                                                                                           <option guid="@i.BeginStr" value="@i.Series">@i.SeriesName</option>                                                                                            
                                                                                        }
                                                                                        <option value="-1" selected>Manual</option>   
                                                                        </select>
                                                                        &nbsp;&nbsp;                                                                            
                                                                            <input type="text" id="DocNum" name="DocNum" class="col form-control form-control-sm">
                                                                                    &nbsp;&nbsp;
                                                                            <select id="Series"  name="Series"
                                                                                class="form-control form-control-sm col">
                                                                                        @foreach (iSOL_Enterprise.Models.Sale.tbl_series i in ViewBag.Series)
                                                                                        {                                                                                            
                                                                                                <option value="@i.Series">@i.SeriesName </option>                                                                                            
                                                                                        }
                                                                                        <option value="-1" selected>Manual</option>   
                                                                            </select> 
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                        </div>
                                                                    </div>


                                                                </div>
                                                                
                                                                <div class="form-group row">

                                                                    <div class="col-md-6">
                                                                        <label>Status</label>
                                                                        <select class="form-control" id="Status" name="Status">
                                                                            <option value="P">Planned</option>
                                                                            <option value="R">Released</option>
                                                                            <option value="L">Closed</option>
                                                                            <option value="C">Canceled</option>
                                                                        </select>

                                                                    </div>

                                                                    <div class="col-md-6 ">
                                                                        <label>Order Date</label>
                                                                        <input type="date" id="PostDate" name="PostDate" class="d mr-5 form-control form-control-sm NotReq">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>


                                                                </div>
                                                                
                                                                <div class="form-group row">

                                                                    <div class="col-md-6">
                                                                        <label>Product No</label>                                                                        
                                                                          <div class="input-group">
                                                                              <input id="ItemmCode" name="ItemCode" type="text" class="form-control form-control-sm" placeholder="Item No." aria-describedby="basic-addon2" readonly>
                                                                              <div id="CodeNo" class="input-group-append">
                                                                                  <span class="input-group-text">
                                                                                      <i class="la la-search"></i>
                                                                                  </span>
                                                                              </div>
                                                                          </div>                                                                           
                                                                    </div>

                                                                    <div class="col-md-6 ">
                                                                        <label>Start Date</label>
                                                                        <input type="date" id="StartDate" name="StartDate" class="d mr-5  form-control form-control-sm NotReq">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>


                                                                </div>
                                                                <div class="form-group row">
                                                                    <div class="col-md-6">
                                                                        <label>Product Description</label>
                                                                        <input id="ItemDescription" name="ProdName" type="text" class="form-control form-control-sm" placeholder="0000" aria-describedby="basic-addon2">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                   <div class="col-md-6 ">
                                                                        <label>Due Date</label>
                                                                        <input type="date" id="DueDate" name="DueDate" class="d mr-5  form-control form-control-sm NotReq">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group row">
                                                                    <div class="col-md-6">
                                                                        <label>Planned Quantity</label>
                                                                        <input id="PlannedQtyH" name="PlannedQtyH" type="number" class="form-control form-control-sm" placeholder="0000" aria-describedby="basic-addon2">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <label>Warehouse</label>                                                                        
                                                                        <select class="form-control Warehousedata" id="ToWH" name="Warehouse"></select>
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>


                                                                </div>
                                                                <div class="form-group row">
                                                                    <div class="col-md-6">
                                                                        <label>Priority</label>
                                                                        <input id="Priority" name="Priority" type="number" class="form-control form-control-sm" MaxValue="32000" placeholder="0000" aria-describedby="basic-addon2" onkeypress="return event.charCode >= 48 && event.charCode <= 57" value="100">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <label>Linked To</label>                                                                        
                                                                        <select class="form-control" id="LinkToObj" name="LinkToObj">
                                                                            <option value="17"> Sales Order</option>
                                                                            <option value="23">Production Order</option>
                                                                            
                                                                        </select>
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>


                                                                </div>
                                                                <div class="form-group row">
                                                                    <div class="col-md-6">
                                                                        <label>Customer</label>
                                                                        <div class="input-group">
                                                                            <input type="text" id="CardCode" name="CardCode" class="form-control form-control-sm " placeholder="Customer" aria-describedby="basic-addon2" readonly>
                                                                            <div id="CustomerNo" class="input-group-append">
                                                                                <span class="input-group-text">
                                                                                    <i class="la la-search"></i>
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <label>Linked Order</label>                                                                        
                                                                        <div class="input-group">
                                                                            <input type="text" id="SalesOrderCode" name="OriginNum" class="form-control form-control-sm " placeholder="Linked Order Number" aria-describedby="basic-addon2" readonly>
                                                                            <div id="SalesOrderNo" class="input-group-append">
                                                                                <span class="input-group-text">
                                                                                    <i class="la la-search"></i>
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>


                                                                </div>
                                                                <div class="form-group row">

                                                                    <div class="col-md-6">
                                                                        <label>Distr Rule</label>
                                                                        <input id="OcrCode" name="OcrCode" type="text" class="form-control form-control-sm NotReq">
                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <label>Project</label>
                                                                        <select id="Project" name="Project" class="form-control form-control-sm  NotReq" asp-items="@ViewBag.ProjectCode">
                                                                             <option value=""> </option>
                                                                        </select>
                                                                    </div>

                                                                </div>


                                                            </div>

                                                            <div class="kt-separator kt-separator--space-md kt-separator--border-dashed"></div>



                                                            <ul class="nav nav-tabs nav-tabs-line nav-tabs-bold nav-tabs-line-3x nav-tabs-line-brand" role="tablist">
                                                                <li class="nav-item">
                                                                    <a class="nav-link active" data-toggle="tab" href="#kt_tabs_contents" role="tab">Contents</a>
                                                                </li>
                                                                

                                                            </ul>
                                                            <div class="tab-content">

                                                                <div class="tab-pane active" id="kt_tabs_contents" role="tabpanel">

                                                                    <div id="kt_tabs_5_1">
                                                                        <table id="kt_repeater_1" style="overflow:auto">
                                                                            <thead class="ScrollThead">
                                                                                <tr>
                                                                                   
                                                                                    <th>Type</th>
                                                                                    <th>Item No.</th>
                                                                                    <th>Item Description</th>
                                                                                    <th>Base Ratio</th>
                                                                                    <th>Ratio</th>
                                                                                    <th>Base Qty</th>
                                                                                    <th>Planned Qty</th>
                                                                                    <th>Warehouse</th>
                                                                                    <th>Available</th>
                                                                                    <th>Issue Method</th>
                                                                                                                                                                       
                                                                                    
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="ListParameters" data-repeater-list="" class="ScrollTbody">
                                                                                
                                                                                <tr class="rowItemDetail align-items-center itm">
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="MaterialType" name="MaterialType">
                                                                                                <option value=1> Item             </option>
                                                                                                <option value=2> Resource         </option>
                                                                                                <option value=3> Text             </option>
                                                                                                <option value=4> Route Stage      </option>
                                                                                            </select>
                                                                                            
                                                                                        </div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <input id="ItemCode" name="ItemCode" type="text" class="form-control form-control-sm" placeholder="Item No." aria-describedby="basic-addon2">
                                                                                            <div id="Itemno" class="input-group-append">
                                                                                                <span class="input-group-text">
                                                                                                    <i class="la la-search"></i>
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input id="ItemName" name="ItemName" class="form-control form-control-sm" type="text">
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm NotReq" id="BaseRatio" name="BaseRatio" type="text" value="1" disabled>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm NotReq" id="Ratio" name="Ratio" type="number" value="1" disabled>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm" id="BaseQty" name="BaseQty" type="number" value="1">
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm" id="PlannedQty" name="PlannedQty" type="number" readonly>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="Warehouse" name="Warehouse">
                                                                                            </select>
                                                                                            
                                                                                        </div>

                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">

                                                                                                <input id="onHand" name="onHand" class="form-control form-control-sm" readonly type="number">
                                                                                                <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="IssueMthd" name="IssueMthd">
                                                                                                <option value="B"> Back Flush  </option>
                                                                                                <option value="M"> Manual      </option>
                                                                                                
                                                                                            </select>
                                                                                            
                                                                                        </div>
                                                                                    </td>
                                                                                    
                                                                                    <td class="d-none">
                                                                                        <input id="LineNum" name="LineNum" class="form-control form-control-sm NotReq" type="number">
                                                                                        <div class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>

                                                                        <div style="margin-top:1%" class="form-group form-group-last row">
                                                                            <div class="col-md-6">
                                                                                <button type="button" id="ListBtnAddd" data-repeater-create="" class="btn btn-light-primary font-weight-bold btn-sm">
                                                                                    <i class="la la-plus"></i> Add
                                                                                </button>
                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                  

                                                                </div>


                                                              
                                                            </div>
                                                        </div>



                                                        <div class="container" id="FooterData">
                                                            <br />
                                                            <br />
 
                                                            
                                                            
                                                                <div class="form-group row">

                                                                    
                                                                    <div class="col-md-6">
                                                                        <label for="inputRemarks" class="form-label" >Remarks</label>
                                                                        <textarea id="Comments" name="Comments" class="form-control" rows="3"></textarea>
                                                                    </div>
                                                                    
                                                                    <div class="col-md-6">
                                                                        <label for="inputRemarks" class="form-label" >Pick & Pack Remarks</label>
                                                                        <textarea id="PickRmrk" class="form-control" name="PickRmrk" rows="3"></textarea>
                                                                    </div>

                                                                </div>
                                                            
                                                            <hr />
                                                        </div>


                                                    </div>

                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <!--end::Portlet-->
                            </div>
                        </div>
                    </div>







                </form>
                <!--end::Form-->
            </div>
        </div>
        <!--end::Card-->

    </div>
    <!--end::Entry-->
</div>
<!-- Render Body <End> -->
<script src="~/Assets/plugins/global/plugins.bundle.js"></script>
<script src="~/Assets/plugins/custom/prismjs/prismjs.bundle.js"></script>
<script src="~/Assets/js/scripts.bundle.js"></script>
<script src="~/js/commonmethods.js"></script>


<script>
    // var vatGroupData = "";
    var WareHouseData = "";
    
    var Quantity = "";
    var OldId = null;
    
    const boxes = document.querySelectorAll('.d');

    for (const box of boxes) {
        box.value = new Date().toJSON().slice(0, 10);
    }


    function GetWareHouseData() {
        $.get("Delivery/GetWareHouseData", function (data) {


            $("#Warehouse").html("");

            $.each(data, function () {

                $("#Warehouse").append($('<option>', {
                    value: this.whscode,
                    text: this.whsname

                }));


                WareHouseData = WareHouseData + "<option  value='" + this.whscode + "'>" + this.whsname + "</option>";
            });

        });
    }
    
    $(document).on('click', '#CustomerNo', function (e) {
        ObjCardCode = $(this);

        generateCustomerTable();
        $('#myCustModal').modal('show');

    });
    $(document).on('click', '#SalesOrderNo', function (e) {
        let linkedTo = $("#LinkToObj").val();
       
        if(linkedTo == 17) {
            generateSalesOrderTable();
            $('#mySalesOrderModal').modal('show');
        }
        else 
        {
                
                generateProductionOrderTable();
                $('#myProductionOrderModal').modal('show');
        }
    });
    $(document).on('click', '#Itemno', function (e) {
        IsHeader = false;
        ObjItemCode = $(this).closest('tr').find("#ItemCode");
        DocModule = "PR";
        generateItemTable();
        $('#myItemModal').modal('show');
        

    });
    $(document).on('input', '#ItemmCode', function (e) {
        
        $.ajax({
					url: 'Common/GetItemData',
					type: 'GET',
					dataType: 'json',
					async: false,
					data: { itemcode: $(this).val(), DocModule: DocModule },
					success: function (data) {
						if (data.success) {

							
							$("#ItemDescription").val((data.item).itemName);
							$('#ItemmCode').val(((data.item).itemCode));
                            GetProdGuid((data.item).itemCode);
						}
					},
					error: function (jqXhr, textStatus, errorMessage) {
						console.log(errorMessage);
					}
				});
    });

    function GetProdGuid(ItemCode) 
    {
        $.ajax({
            url: 'Common/GetProdGuid',
            type: 'GET',
            dataType: 'json',
            async: false,
            data: { itemcode: ItemCode },
            success: function (data) {
                if (data.success) 
                {
                    if(data.guid != null && data.guid != "" && data.guid != undefined)
                    GetProdData(data.guid);
                    
                }
            },
            error: function (jqXhr, textStatus, errorMessage) {
                console.log(errorMessage);
            }
        });
    }

    $(document).on('input', '#Quantity', function (e) {
        Quantity = $(this).val();
        $("#QTY").val(Quantity);
    });
    $(document).on('click', '#CodeNo', function (e) {
        
        HeaderItemCodeClick = true;
        
        generateItemTable();
        $('#myItemModal').modal('show');

    });
    $(document).on('input', '#PlannedQtyH', function (e) {
        UpdatePlannedQtyRow();
    });
    $(document).on('input', '#BaseQty', function (e) 
    {
        if (this.value != null && this.value != "" && this.value != undefined)
        {
            var value = parseFloat(this.value);
            var decimalCount = (this.value.split(".")[1] || []).length;
            if (decimalCount > 4) {
                this.value = value.toFixed(4);
            }

            $(this).closest('tr').find("#PlannedQty").val( ($("#PlannedQtyH").val() * value).toFixed(4));

            //let decimalPart = value.toString().substring(value.toString().indexOf(".")+1);
            //let divisorPart = Math.ceil (decimalPart / value);  //To get divisor Part
            //let BaseRatio = (decimalPart.toString() + "/" + divisorPart).toString();

            //$(this).closest('tr').find("#BaseRatio").val(BaseRatio);

            UpdateRatio();  //To Update Ratios of all rows
        }

    });
    function GetSumRowsBaseQty() 
    {   let sum = 0;
        $('#ListParameters .itm').each(function () 
        {
            let value = parseFloat($(this).find("#BaseQty").val());
            let decimalPart = value.toString().split(".")[1];
            sum = sum + value;

        });
        return sum;
    }
    function UpdateRatio() {

        $.when(GetSumRowsBaseQty()).then(function (sum) {

            $('#ListParameters .itm').each(function () {

                let value = $(this).find('#BaseQty').val();
               // let decimalPart = value.toString().substring(value.toString().indexOf(".")+1);
                let decimalPart = value.toString().split(".")[1];
                let divisor = 0;
                let dividend = 0;
                let FloorPart =  Math.floor(value);
                console.log(decimalPart);
                console.log(FloorPart);

                if(decimalPart != 0 && FloorPart!=0 && decimalPart != undefined)
                {                    
                    divisor = decimalPart / value.toString().substring(value.toString().indexOf("."));
                    dividend = Number(decimalPart) + Number( FloorPart * divisor );
                    
                }
                else if (FloorPart == 0 && decimalPart != undefined && decimalPart != 0) {
                    divisor = decimalPart / value.toString().substring(value.toString().indexOf("."));
                    dividend = decimalPart;
                    
                }
                else if(FloorPart != 0 && decimalPart == undefined)
                {
                    divisor = 10000;
                    dividend = Number( FloorPart * divisor );
                }
                //if(decimalPart <= 0)
                //{                    
                //    $(this).find("#BaseRatio").val(dividend + "/10000");
                //}
                //else 
                //{

                //let divisorPart = Math.ceil (decimalPart / value);  //To get divisor Part
                //let BaseRatio = (decimalPart.toString() + "/" + divisorPart).toString();

                //$(this).find("#BaseRatio").val(BaseRatio);
                //}
                
                $(this).find("#BaseRatio").val(dividend + "/" + divisor);
                $(this).find('#Ratio').val(((value / sum) * 100).toFixed(4));

            });
            
        });
    }

    function UpdatePlannedQtyRow(){
    
        $('#ListParameters .itm').each(function () {
            $(this).find('#PlannedQty').val($(this).find("#BaseQty").val() * $("#PlannedQtyH").val());
        });
    }
    

    $(document).ready(function () {


        DocModule = "PRO";
        GetWareHouseDataThroughClass();
        
        GetWareHouseData();
        

        var date = new Date;
        $('#DocDate').val(moment(date).format('YYYY-MM-DD'));
       
        $("#ToWH").select2();
       

        if ("@ViewBag.OldId" != "0") {
            
            $("#btnSaveData").html('<i class="ki ki-check icon-sm"></i> Update');
            $("#btnSaveData").attr('disabled', true);
            
            OldId = "@ViewBag.OldId";
            isEdit = true;

            $("#ItemmCode").attr('disabled', true);
            $("#ItemDescription").attr('disabled', true);
            $("#HeaderTitle2").text('Update');
            $("#MySeries").attr('disabled', true);
            $("#Series").attr('disabled', true);
            $("#DocNum").attr('disabled', true);
            $("#CodeNo").hide();
            GetOldData();
        }
    });

    function GetWareHouseDataThroughClass() {
    
    $.ajax({
        url: 'Delivery/GetWareHouseData',
        type: 'GET',
        dataType: 'json',
        async: false,
        success: function (data) {

            const ii = document.querySelectorAll('.Warehousedata');
            for (const i of ii) {                          
            $.each(data, function () {
                i.innerHTML += "<option  value='" + this.whscode + "'>" + this.whsname + "</option>";                             
            });
            }
        },
        error: function (jqXhr, textStatus, errorMessage) {
            console.log(errorMessage);
        }
    });

    } 
    
    $(document).on('click', '#btnBack', function (e) {

        window.history.back();
    });
    
    $(document).on("keydown", "input", function () 
    {
        $(this).removeClass('is-invalid');
        
        //if(this.type = 'number')
        //{
        //    let maxValue = $(this).attr('MaxValue');           
        //    if(maxValue != "" && maxValue != undefined && maxValue != 'NaN')
        //        if(parseFloat($(this).val()) > parseFloat(maxValue))
        //            $(this).val(maxValue);
        //}


    });
    $(document).on("input", "input[type='number']", function () {
        var value = parseFloat(this.value);
        if (isNaN(value)) {
            return;
        }
        

        let maxValue = $(this).attr('MaxValue');           
            if(maxValue != "" && maxValue != undefined && maxValue != 'NaN')
            {
                if(parseFloat($(this).val()) > parseFloat(maxValue))
                    $(this).val(maxValue);

            }
    });

    $(document).on('click', '#ListBtnDelete', function () {
        $(this).closest('tr').remove();
    });
   
    $(document).on('change', '#MySeries', function () {


        if ($(this).val() == -1) {

            $('#DocNum').attr("readonly", false);
            $('#DocNum').val("");
        }
        else {
            $('#DocNum').attr("readonly", true);

            return $.ajax({
                url: '/ItemMasterData/GetNewItemCode',
                dataType: 'json',
                type: 'Get',

                data: { Series: $(this).val() },

                success: function (result) {

                    if (result.success) {

                        $('#DocNum').val(result.itemCode);

                    }

                    if (!(result.success)) {
                        toastr.error("An error occured while getting Card Code");

                    }

                },
                error: function (jqXhr, textStatus, errorMessage) {
                    console.log(errorMessage);
                }

            }).done(function (result) {

            });
        }
    });

    $(document).on('click', '#ListBtnAddd', function (e) {
    
     var html = `
              <tr class="rowItemDetail align-items-center itm">
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="MaterialType" name="MaterialType">
                                                                                                <option value=1> Item             </option>
                                                                                                <option value=2> Resource         </option>
                                                                                                <option value=3> Text             </option>
                                                                                                <option value=4> Route Stage      </option>
                                                                                            </select>
                                                                                            
                                                                                        </div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <input id="ItemCode" name="ItemCode" type="text" class="form-control form-control-sm" placeholder="Item No." aria-describedby="basic-addon2">
                                                                                            <div id="Itemno" class="input-group-append">
                                                                                                <span class="input-group-text">
                                                                                                    <i class="la la-search"></i>
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input id="ItemName" name="ItemName" class="form-control form-control-sm" type="text">
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm NotReq" id="BaseRatio" name="BaseRatio" type="text" value="1" disabled>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm NotReq" id="Ratio" name="Ratio" type="number" value="1" disabled>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm" id="BaseQty" name="BaseQty" type="number" value="1">
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    
                                                                                    <td>
                                                                                        <input class="form-control form-control-sm" id="PlannedQty" name="PlannedQty" type="number" readonly>
                                                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="Warehouse" name="Warehouse">
                                                                                                `+ WareHouseData + `
                                                                                            </select>
                                                                                            
                                                                                        </div>

                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">

                                                                                                <input id="onHand" name="onHand" class="form-control form-control-sm" readonly type="number">
                                                                                                <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <div class="input-group">
                                                                                            <select class="form-control" id="IssueMthd" name="IssueMthd">
                                                                                                <option value="B"> Back Flush  </option>
                                                                                                <option value="M"> Manual      </option>
                                                                                                
                                                                                            </select>
                                                                                            
                                                                                        </div>
                                                                                    </td>
                                                                                    
                                                                                    <td class="d-none">
                                                                                        <input id="LineNum" name="LineNum" class="form-control form-control-sm NotReq" type="number">
                                                                                        <div class="error invalid-feedback">This field is required.</div>
                                                                                    </td>
                                                                                    <td>
                                                                                        <a id = "ListBtnDelete" class="btn btn-bold btn-sm btn-light-danger">
                                                                                        <i class="la la-trash"></i> X
                                                                                       </a>
                                                                                   </td>
                                                                                </tr>
        `;
        $('#kt_repeater_1 tbody').append(html);
       
        $('#ListParameters tr:last-child').find("#PlannedQty").val($("#PlannedQtyH").val());
        $('#ListParameters tr:last-child').find("#BaseQty").val("1");
        $('#ListParameters tr:last-child').find("#BaseRatio").val("1");
        
        
    });


    //================== Post Data Working =====================//

    

    $(document).on('click', '#btnSaveData', function (e) {

        $(this).addClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
        $(this).attr('disabled', true);

        if (ValidateData("HeaderForm") ) {
            if (ValidateListData("ListParameters .itm")) {
                    FormData();                
            }
            else {
                $(this).removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                $(this).attr('disabled', false);
            }


        }
        else {
            $(this).removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
            $(this).attr('disabled', false);
        }
    });


    function FormData() {
        var data =
        {
            HeaderData: getJsonObjKeyName("HeaderForm"),
            ListItems: getJsonObjListKeyName("ListParameters .itm"),
            FooterData: getJsonObjKeyName("FooterData"),
            OldId: OldId
            //BaseType : BaseType
        }
       //console.log(data);
       PostData(data);


    } 
      

     function PostData(formData) 
    {                  
        return $.ajax({
            url: '/ProductionOrder/AddUpdateProductionOrder',
            dataType: 'json',
            type: 'POST',
            
             data: { formData: JSON.stringify(formData)},

            success: function (result) 
            {
                console.log(result);
                if (result.isInserted) {
                    toastr.success(result.message);

                    setTimeout(
                        function () 
                        {

                            $('#btnSaveData').removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                            $('#btnSaveData').attr('disabled', false);

                        }, 800);
                    setTimeout(function () {
                        window.history.back();
                    }, 800);


                }

                if (!(result.isInserted)) {
                    toastr.error(result.message);
                    $('#btnSaveData').removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                    $('#btnSaveData').attr('disabled', false);

                }

            },
            error: function (jqXhr, textStatus, errorMessage) {
                console.log(errorMessage);
            }

        }).done(function (result) {

        });
    }

     function GetProdData(guid) 
    {

        $.ajax({
            url: 'BillOfMaterial/GetOldData',
            type: 'GET',
            dataType: 'json',
            async : false,
            data: { guid: guid },
            success: function (data) 
            {
                
                let HeaderData = JSON.parse(data.headerData);  
                
                $.each(HeaderData[0][0], function (key, value) {
                   
                    if ($("#" + key).is(':checkbox') || $(this).is(':radio'))
                    {
                         if(value == 'Y') {
                         $("#" + key).prop('checked', true);
                         
                         }
                         else
                         {
                           
                            $("#" + key).prop('checked', false);
                            
                         }
                    }
                    else if($("#" + key).attr('type') === 'date') 
                    {
                        $("#" + key).val(moment(value).format('yyyy-MM-DD'));
                        
                    }
                    else
                    {
                        
                         $("#" + key).val(value);
                    }
                    


                });
               //Row Data
                let RowData = JSON.parse(data.rowData);                  
                let j = 0;
                $.each(RowData[0], function (key, value) { 

                    if(j == 0) 
                    {
                      
                        $("#ItemCode").val(this.Code); 
                        $("#ItemName").val(this.ItemName); 
                        $("#Warehouse").val(this.Warehouse);                       
                        $("#BaseQty").val(this.Quantity);
                        $("#PlannedQty").val(this.Quantity * $("#PlannedQtyH").val());                        
                        $("#LineNum").val(this.ChildNum);
                        $("#Comment").val(this.Comment);

                        
                         
                        $.when(GetWareHouseQty(this.Father, this.Warehouse)).done(function (OnHand) {

                            $("#onHand").val(Number(OnHand));

                        });

                    }
                    else {
                        //AddWarehouseRowData(this);
                          
                        $('#ListBtnAddd').trigger('click'); 
                        InitializeWareHouseData();
                        $('#ListParameters tr:last-child').find("#Warehouse").html(WareHouseData);
                         


                        $('#ListParameters tr:last-child').find("#ItemCode").val(this.Code);
                        $('#ListParameters tr:last-child').find("#ItemName").val(this.ItemName);
                        $('#ListParameters tr:last-child').find("#Warehouse").val(this.Warehouse);
                        $('#ListParameters tr:last-child').find("#BaseQty").val(this.Quantity);                        
                        $('#ListParameters tr:last-child').find("#PlannedQty").val(this.Quantity * $("#PlannedQtyH").val());                        
                        $('#ListParameters tr:last-child').find("#LineNum").val(this.ChildNum);
                        $('#ListParameters tr:last-child').find("#Comment").val(this.Comment);

                        

                        
                        
                        $.when(GetWareHouseQty(this.ItemCode, this.Warehouse)).done(function (OnHand) {

                            $('#ListParameters tr:last-child').find("#onHand").val(Number(OnHand));

                        });
                    
                    }
                    j += 1;


                });
                 
                UpdateRatio();
                $("#btnSaveData").attr('disabled', false);
                
                
            },
            error: function (jqXhr, textStatus, errorMessage) {
                console.log(errorMessage);
            }
        });
    }

    function GetOldData() 
    {

        $.ajax({
            url: 'ProductionOrder/GetOldData',
            type: 'GET',
            dataType: 'json',
            async : false,
            data: { guid: OldId },
            success: function (data) 
            {
                
                let HeaderData = JSON.parse(data.headerData);  
                
                $.each(HeaderData[0][0], function (key, value) {
                   
                    if ($("#" + key).is(':checkbox') || $(this).is(':radio'))
                    {
                         if(value == 'Y') {
                         $("#" + key).prop('checked', true);
                         
                         }
                         else
                         {
                           
                            $("#" + key).prop('checked', false);
                            
                         }
                    }
                    else if($("#" + key).attr('type') === 'date') 
                    {
                        $("#" + key).val(moment(value).format('yyyy-MM-DD'));
                        
                    }
                    else
                    {
                            if(key == 'ItemCode')
                            $("#ItemmCode").val(value).trigger('change');
                            else if(key == 'PlannedQty')
                            $("#PlannedQtyH").val(value);
                            else if(key == 'Warehouse')
                            $("#ToWH").val(value);
                            else if (key == 'OriginNum')
                            $("#SalesOrderCode").val(value);
                            else if (key == 'ProdName')
                            $("#ItemDescription").val(value);
                            
                            else
                            $("#" + key).val(value);
                    }
                    


                });
               //Row Data
                let RowData = JSON.parse(data.rowData);                  
                let j = 0;
                $.each(RowData[0], function (key, value) { 

                    if(j == 0) 
                    {
                      

                        $("#ItemCode").val(this.ItemCode); 
                        $("#ItemName").val(this.ItemName); 
                        $("#Warehouse").val(this.wareHouse);                       
                        $("#BaseQty").val(this.BaseQty).trigger('change');
                        $("#PlannedQty").val(this.PlannedQty);                        
                        $("#LineNum").val(this.LineNum);
                        $("#Comment").val(this.Comment);
                                                 
                        $.when(GetWareHouseQty(this.ItemCode, this.wareHouse)).done(function (OnHand) {

                            $("#onHand").val(Number(OnHand));

                        });

                    }
                    else {
                        //AddWarehouseRowData(this);
                        
                        $('#ListBtnAddd').trigger('click'); 
                        InitializeWareHouseData();
                        $('#ListParameters tr:last-child').find("#Warehouse").html(WareHouseData);
                         

                        $('#ListParameters tr:last-child').find("#ItemCode").val(this.ItemCode);
                        $('#ListParameters tr:last-child').find("#ItemName").val(this.ItemName);
                        $('#ListParameters tr:last-child').find("#Warehouse").val(this.wareHouse);
                        $('#ListParameters tr:last-child').find("#BaseQty").val(this.BaseQty);                        
                        $('#ListParameters tr:last-child').find("#PlannedQty").val(this.PlannedQty);                        
                        $('#ListParameters tr:last-child').find("#LineNum").val(this.LineNum);
                        $('#ListParameters tr:last-child').find("#Comment").val(this.Comment);

                        
                        $.when(GetWareHouseQty(this.ItemCode, this.wareHouse)).done(function (OnHand) {

                            $('#ListParameters tr:last-child').find("#onHand").val(Number(OnHand));

                        });
                    
                    }
                    j += 1;


                });
                 

                UpdateRatio();
                $("#btnSaveData").attr('disabled', false);
                
            },
            error: function (jqXhr, textStatus, errorMessage) {
                console.log(errorMessage);
            }
        });
    }
</script>

