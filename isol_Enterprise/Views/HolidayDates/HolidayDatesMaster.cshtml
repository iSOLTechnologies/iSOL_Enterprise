@{
    ViewData["Title"] = "HolidayDatesMaster";
    ViewBag.title1 = "Holiday Dates / ";    
    ViewBag.title2 = "Add";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model iSOL_Enterprise.Models._usersModels
@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = "HolidayDatesMaster";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<input type="hidden" value="@HttpContextAccessor.HttpContext.Session.GetString("Name")" id="sessionName" />
<input type="hidden" value="@HttpContextAccessor.HttpContext.Session.GetString("Email")" id="sessionEmail" />
<input type="hidden" value="@HttpContextAccessor.HttpContext.Session.GetString("RoleCode")" id="UserRoleCode" />
<input type="hidden" value="@HttpContextAccessor.HttpContext.Session.GetString("DepartmentCode")" id="_DepartmentCode" />


<input type="hidden" value="@Context.Request.Query["Source"]" id="PageGuid" />
<input type="hidden" value="" id="TicCode" />
<input type="hidden" value="@HttpContextAccessor.HttpContext.Session.GetInt32("UserId")" id="_UserId" />
<title>User Master</title>
<style>
    .td {
        width:200px;
    }
    #table_container {
        max-height: 350px;
        /* margin-bottom: 10px;*/
        overflow-x: scroll;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
    }
</style>

<div class="container">
    <!--begin::Card-->
    <div class="card card-custom card-sticky" id="kt_page_sticky_card">
        <div class="card-header">
            <div class="card-title">
                <h3 class="card-label">
                    Add Details
                    <i class="mr-2"></i>
                    <!-- <small class="">try to scroll the page</small> -->
                </h3>
            </div>
            <div class="card-toolbar">
                <a onclick="Back_his()" class="btn btn-light-primary font-weight-bolder mr-2">
                    <i class="ki ki-long-arrow-back icon-sm"></i>Back
                </a>
                <div class="btn-group">

                    <button type="button" class="btn btn-primary font-weight-bolder" id="btnSaveData">
                        <i class="ki ki-check icon-sm"></i>Save
                    </button>

                </div>
            </div>
        </div>
        <div class="card-body">
            <form autocomplete="off" role="form" id="F_@Context.Request.Query["Source"]" name="F_@Context.Request.Query["Source"]">
                <input type="hidden" value="@Context.Request.Query["Id"]" id="Guid" />
                <div class="row">
                    
                    <div class="col-xl-12">

                        <div  id="HeaderForm">
                            
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label class="col-form-label mr-2 ">Holidays <span class="text-danger">*</span></label>
                                    <input type="text" id="HldCode" name="HldCode" class="form-control" char="20">
                                    <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                </div>

                                
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label class="col-form-label mr-2 ">Week Numbering First Week<span class="text-danger">*</span></label>

                                    <div class="d-flex row">
                                        <div class="radio-inline col-4">
                                            <label class="radio radio-outline radio-success">
                                                <input type="radio" name="WeekNoRule" value="J" checked />
                                                <span></span>
                                                Start on January 1
                                            </label>
                                        </div>
                                        <div class="radio-inline col-4">
                                            <label class="radio radio-outline radio-success">
                                                <input type="radio" name="WeekNoRule" value="D" />
                                                <span></span>
                                                Starts in first 4-day week
                                            </label>
                                        </div>
                                        <div class="radio-inline col-4">
                                            <label class="radio radio-outline radio-success">
                                                <input type="radio" name="WeekNoRule" value="F" />
                                                <span></span>
                                                Starts in first full week
                                            </label>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="form-group row">
                            
                                <div class="col-md-6">
                                    <label class="col-form-label  ">Weekend from <span class="text-danger">*</span></label>
                                    <div class="d-flex row ml-1">

                                        <select class="form-control col-5 mr-2" name="WndFrm">

                                            @foreach (iSOL_Enterprise.Models.ListModel i in ViewBag.WeekDays)
                                            {
                                                @if (@i.Value == 5)
                                                {                                                    
                                                <option value="@i.Value" selected>@i.Text </option>
                                                }
                                                else {

                                                <option value="@i.Value">@i.Text </option>
                                                }
                                            }
                                        </select>
                                        <span class="pt-3">
                                            TO
                                        </span>
                                        <select class="form-control col-5 ml-2" name="WndTo">

                                            @foreach (iSOL_Enterprise.Models.ListModel i in ViewBag.WeekDays)
                                            {
                                                @if (@i.Value == 7)
                                                {                                                    
                                                    <option value="@i.Value" selected>@i.Text </option>
                                                }
                                                else
                                                {
                                                <option value="@i.Value">@i.Text </option>                                                    
                                                }
                                            }
                                        </select>

                                    </div>
                                </div>
                                
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6 d-flex">
                                    <div class="checkbox-inline col-6">
                                        <label class="checkbox checkbox-outline checkbox-success">
                                            <input type="checkbox" name="isCurYear" />
                                            <span></span>
                                            Valid For One Year Only
                                        </label>
                                    </div>
                                    <div class="checkbox-inline col-6">
                                        <label class="checkbox checkbox-outline checkbox-success">
                                            <input type="checkbox" name="ignrWnd" />
                                            <span></span>
                                            Set Weekends as Work Days
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                        <div class="tab-content">

                            <div class="tab-pane active   mt-5"
                                 id="kt_tabs_General" role="tabpanel">

                                <div class="row">
                                    <div class=" nav nav-tabs nav-tabs-line nav-tabs-bold nav-tabs-line-3x nav-tabs-line-brand col-12 mt-5 mb-5"> </div>
                                    <div class="col-md-9 col-sm-12 col-lg-9 scrollbar" id="table_container">

                                        <table id="kt_repeater_1">
                                            <thead class="ScrollThead">
                                                <tr>
                                                    <th class="text-center">Start Date <span class="text-danger">*</span></th>
                                                    <th class="text-center">End Date <span class="text-danger">*</span></th>
                                                    <th class="text-center">Remarks</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="ListParameters" data-repeater-list="" class="ScrollTbody">
                                                
                                                <tr class="rowItemDetail align-items-center itm">
                                                    
                                                    <td class="td">
                                                        <input name="StrDate" class="form-control"  type="date">
                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                    </td> 
                                                    <td class="td">
                                                        <input name="EndDate" class="form-control"  type="date">
                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                    </td> 
                                                    <td class="td">
                                                        <input name="Rmrks" class="form-control NotReq"  type="text" char="50">
                                                        <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                                                    </td>
                                                    
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div style="margin-top:1%" class="form-group form-group-last row">
                                            <div class="col-md-6">
                                                <button type="button" id="ListBtnAddd" data-repeater-create="" class="btn btn-light-primary font-weight-bold btn-sm">
                                                    <i class="la la-plus"></i> Add
                                                </button>
                                            </div>
                                        </div>


                                    </div>
                                </div>



                            </div>

                            

                        </div>



                    </div>
                    <div class="col-xl-1"></div>
                </div>

            </form>
        </div>
    </div>
</div>
<script src="~/Assets/plugins/global/plugins.bundle.js"></script>
<script src="~/Assets/plugins/custom/prismjs/prismjs.bundle.js"></script>
<script src="~/Assets/js/scripts.bundle.js"></script>
<script src="~/js/myjson_validate.js"></script>

<script>
    $(document).ready(function () {


        let Guid = $('#Guid').val();

        if (Guid != null && Guid != '' && Guid != undefined) {
            $("#btnSaveData").html('<i class="ki ki-check icon-sm"></i> Update');
            $("#btnSaveData").attr('disabled', true);
            $('#HldCode').attr('disabled', true);
            $("#HeaderTitle2").text('Update');
            GetHolidayDateData(Guid);
        }


        //GetCompanyDetails();


    });



    $(document).on('click', '#btnSaveData', function (e) {

        $(this).addClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
        $(this).attr('disabled', true);


        if (ValidateData("HeaderForm")) {

            if (ValidateListData("kt_repeater_1")) {

                FormData();
                
            }
            else 
            {

                $(this).removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                $(this).attr('disabled', false);

            }
        }
        else {

            $(this).removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
            $(this).attr('disabled', false);
            
        }
    });
    function FormData() {

        var formdata =
        {

            HeaderData: getJsonObjKeyName("HeaderForm"),
            RowData: getJsonObjListKeyName("ListParameters .itm")

        }
//        console.log(formdata);

       PostData(formdata);


    }

    function PostData(formData) {

        let Guid = $('#Guid').val();
        let URL = '/HolidayDates/Add';
        if (Guid != null && Guid != '' && Guid != undefined) {
            URL = '/HolidayDates/Edit';
        }

        return $.ajax({
            url: URL,
            dataType: 'json',
            type: 'POST',

            data: { formData: JSON.stringify(formData) },

            success: function (result) {
                console.log(result);
                if (result.isInserted) {
                    toastr.success(result.message);

                    setTimeout(
                        function () {

                            $('#btnSaveData').removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                            $('#btnSaveData').attr('disabled', false);

                        }, 800);
                    setTimeout(function () {
                        window.history.back();
                    }, 800);


                }

                if (!(result.isInserted)) {
                    toastr.error(result.message);
                    $('#btnSaveData').removeClass('kt-spinner kt-spinner--right kt-spinner--md kt-spinner--light');
                    $('#btnSaveData').attr('disabled', false);

                }

            },
            error: function (jqXhr, textStatus, errorMessage) {
                console.log(errorMessage);
            }

        }).done(function (result) {

        });
    }

    $(document).on('click','#ListBtnAddd', function() {

        var html = `    <tr class="rowItemDetail align-items-center itm">

                           <td class="td">
                               <input name="StrDate" class="form-control "  type="date">
                               <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                           </td>
                           <td class="td">
                               <input name="EndDate" class="form-control "  type="date">
                               <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                           </td>
                           <td class="td">
                                   <input name="Rmrks" class="form-control NotReq"  type="text" char="50">
                               <div id="ErrorMsg" class="error invalid-feedback">This field is required.</div>
                           </td>
                           <td>
                                <a id = "ListBtnDelete" class="btn btn-bold btn-sm btn-light-danger">
                                <i class="la la-trash"></i> X
                               </a>
                           </td>
                       </tr> `;
        $('#kt_repeater_1 tbody').append(html);
    });

    $(document).on('click', '#ListBtnDelete', function () {
        $(this).closest('tr').remove();
    });

    function GetHolidayDateData(Guid) {

        $.ajax({
            url: 'HolidayDates/GetHolidayDateData',
            type: 'GET',
            dataType: 'json',
            data: { Guid : Guid },
            async: false,
            success: function (data) {
                let HeaderData = JSON.parse(data.headerData);
                let RowData = JSON.parse(data.rowData);
                let j = 0;
                let selector = $('#ListParameters tr:last-child');
                

                $.each(HeaderData[0][0], function (key, value) {

                    UpdateFormData(key, value);

                });
                $.each(RowData[0], function (key, value) {
                    
                   
                    if (j == 0) 
                    {
                            $.each(this, function (key, value) {


                                UpdateFormListData(selector, key, value)

                            })
                        
                    }
                    else 
                    {

                        $('#ListBtnAddd').trigger('click');

                        $('#ListParameters tr:last-child').find("[name='StrDate']").val(moment(this.StrDate).format('yyyy-MM-DD'));
                        $('#ListParameters tr:last-child').find("[name='EndDate']").val(moment(this.EndDate).format('yyyy-MM-DD'));
                        $('#ListParameters tr:last-child').find("[name='Rmrks']").val(this.Rmrks);
                    }

                    j += 1;

                    

                });


                $("#btnSaveData").attr('disabled', false);
            }
        });
    }

    function UpdateFormData(key, value) 
    {
        if ($('[name="' + key + '"]').is(':checkbox')) {
            if (value == 'Y') {
                $('[name="' + key + '"]').prop('checked', true);

            }
            else {

                $('[name="' + key + '"]').prop('checked', false);

            }
        }
        else if ($('[name="' + key + '"]').is(':radio')) {
            $('[name="' + key + '"][value="' + value + '"]').prop('checked', true);
        }
        else if ($('[name="' + key + '"]').attr('type') === 'date') {
            $('[name="' + key + '"]').val(moment(value).format('yyyy-MM-DD'));

        }
        else {

            $('[name="' + key + '"]').val(value);
        }
    }

    function UpdateFormListData(selector,key,value) 
    {
        
        if ($(selector).find('[name="' + key + '"]').attr('type') === 'date') 
        {
            $(selector).find('[name="' + key + '"]').val(moment(value).format('yyyy-MM-DD'));

        }
        else {

            $(selector).find('[name="' + key + '"]').val(value);
        }
    }

</script>

